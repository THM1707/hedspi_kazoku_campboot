<script>
  $(document).ready(function(){
    $("body").delegate("input", "click",function(event){
      event.preventDefault();
      let ratingValue = parseInt($('#stars li.selected').last().data('value'), 10);
      let content = $('.content').val().trim();
      let company_id = <%= @company.id %>;
      let user_id = <%= current_user.id %>;
  
      if (!content){
        alert('Content can not be empty');
        return false;
      }
  
      if (!ratingValue){
        alert('Rating can not be empty');
        return false;
      }
  
      var settings = {
        "async": true,
        "crossDomain": true,
        "url": `/companies/${company_id}/reviews`,
        "method": "POST",
        "headers": {
          "Content-Type": "application/json",
          "cache-control": "no-cache",
        },
        "processData": false,
        "data":  `{
          "rating":"${ratingValue}",
          "user_id":"${user_id}",
          "content":"${content}"
          }`
      }
  
      $.ajax(settings).done(function (response) {
        let starHTML = "";
        for (let i = 0; i < ratingValue; i++) {
            starHTML += `
              <li class='star selected'>
                <i class='fa fa-star fa-fw'></i>
              </li>
            `
        }
        $(event.target).closest("form").replaceWith(`
          <div class="row" style="padding-top:10px;" id = ${response.data.id}>
            <div class="col-md-1 align-self-center">
              <% if current_user.picture.presence %>
                <%= image_tag(current_user.picture.thumb.url, class: "rounded-circle mx-auto d-block float-left", alt: "image", width: "75px", height: "75px") %>
              <% else %>
                <img src="http://www.personalbrandingblog.com/wp-content/uploads/2017/08/blank-profile-picture-973460_640-300x300.png"
                            class="rounded-circle mx-auto d-block" alt="image" width="75px" height="75px">
              <% end %>
            </div>
            <div class="col-md-6">
              <div class="card" style="border: none">
                <div class="card-body">
                  <button class="btn btn-light float-right" id="delete-btn">
                    <i class="fas fa-times"></i>
                  </button>
                  <button class="btn btn-light float-right" id="edit-btn">
                    <i class="fa fa-edit fa-1x"></i>
                  </button>
                  <%= link_to current_user.name, current_user %>
                  <span class="date">just now</span>
                  <br/>
                  <div style="padding-top:10px">
                      <div class='rating-stars'>
                      <ul>
                        ${starHTML}
                      </ul>
                      </div>
                  </div>
                  <p id="content_box_${response.data.id}">
                    ${content}
                  </p>
                </div>
              </div>
            </div>
          </div>
        `);
      });
    });
  });
</script>
<script>
  $(document).ready(function(){
    let star5 = <%= @company.reviews.star(5).count %>;
    let star4 = <%= @company.reviews.star(4).count %>;
    let star3 = <%= @company.reviews.star(3).count %>;
    let star2 = <%= @company.reviews.star(2).count %>;
    let star1 = <%= @company.reviews.star(1).count %>;
    google.charts.setOnLoadCallback(function() { drawBasic(
      star5,star4,star3,star2,star1
      );
    });
  });
</script>
<script>
  $(document).ready(function(){
    let avatar = `<%= render "avatar" %>`;
    let star = `<%= render "star" %>`
    $("body").delegate("#edit-btn", "click",function(event){
    $(event.target).closest(".row").replaceWith(`
      <form>
        ${avatar}
        <div class="col-md-11" style="padding-left:30px;">
            ${star}
            <li>
            <textarea rows="2" cols="60" placeholder="Write your comment here" class="content"></textarea>
            </li>
            <li>
            <input type="submit" name="commit" value="Submit" class="submit-review">
            </li>
        </div>
      </form>
    `)
    });
  });
</script>
<%= render "star_js" %>
<script>
  $("body").delegate("#delete-btn", "click",function(event){
    let avatar = `<%= render "avatar" %>`;
    let star = `<%= render "star" %>`
    let id = $(event.target).closest(".row").attr('id');
    let company_id = <%= @company.id %>
    var settings = {
      "async": true,
      "crossDomain": true,
      "url": `/companies/${company_id}/reviews/${id}`,
      "method": "DELETE",
      "headers": {
        "cache-control": "no-cache",
      }
    }
    $.ajax(settings).done(function (response) {
      $(event.target).closest(".row").replaceWith(`
        <form>
          ${avatar}
          <div class="col-md-11" style="padding-left:30px;">
              ${star}
              <li>
              <textarea rows="2" cols="60" placeholder="Write your comment here" class="content"></textarea>
              </li>
              <li>
              <input type="submit" name="commit" value="Submit" class="submit-review">
              </li>
          </div>
        </form>
    `)
    });
  });
</script>
